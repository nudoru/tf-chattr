/*! app-framework 03-08-2015 */
define("APP.Application",function(a,b,c){function d(){var b,c;l=this,b=this.createApplicationModel(a("APP.Model.AppModel")),c=this.createApplicationView(a("APP.View.AppView")),this.initializeApplication({model:b,view:c}),o.subscribe(n.PUBLISH_MESSAGE,e),o.subscribe(n.NICK_UPDATE,g),o.subscribe(n.USER_STARTTYPING,j),o.subscribe(n.USER_ENDTYPING,k),this.view().initialize(),this.model().initialize(),this.view().removeLoadingMessage(),this.setCurrentRoute(APP.router().getCurrentRoute()),this.view().render(),m=io(),m.on("message",f),m.on("userupdate",h),m.on("assignnick",i)}function e(a){m.emit("message",{time:l.model().prettyNow(),username:a.payload.username,message:a.payload.message})}function f(a){l.model().addMessage(a.username,a.message)}function g(a){m.emit("nickchange",a.payload.nick)}function h(a){l.model().setUsers(a)}function i(a){l.view().setMyNick(a),l.model().setMyNick(a)}function j(){m.emit("typingstart")}function k(){m.emit("typingend")}var l,m,n=a("App.Events.EventConstants"),o=(a("App.Events.EventCreator"),a("Nori.Utils.Dispatcher"));c.initialize=d}),define("App.Events.EventConstants",function(a,b,c){var d=a("Nudoru.Core.ObjectUtils");_.merge(c,d.keyMirror({PUBLISH_MESSAGE:null,NICK_UPDATE:null,NICK_ASSIGNED:null,USER_STARTTYPING:null,USER_ENDTYPING:null}))}),define("App.Events.EventCreator",function(a,b,c){var d=a("Nori.Utils.Dispatcher"),e=a("App.Events.EventConstants");c.publishMessage=function(a,b){d.publish({type:e.PUBLISH_MESSAGE,payload:{username:a,message:b}})},c.updateNick=function(a){d.publish({type:e.NICK_UPDATE,payload:{nick:a}})},c.startTyping=function(){d.publish({type:e.USER_STARTTYPING,payload:{}})},c.endTyping=function(){d.publish({type:e.USER_ENDTYPING,payload:{}})}}),define("APP.Model.AppModel",function(a,b,c){function d(){p=this,w.subscribe(v.PUBLISH_MESSAGE,m),w.subscribe(v.NICK_UPDATE,n),r=p.createMapCollection({id:"UsersCollection"}),s=p.createMapCollection({id:"MessagesCollection"}),t.applicationModelInitialized()}function e(){return r}function f(){return s}function g(){return q}function h(a){q=a}function i(a){r.removeAll(),a.forEach(function(a){j(a)})}function j(a){a&&r.add(p.createMap({id:a.id,store:{username:a.nick,status:a.status,typing:a.typing}}))}function k(a){r.remove(a)}function l(a,b){console.log("model, addMessage"),a=a||"Unknown",s.add(p.createMap({id:u++,store:{time:o(),username:a,content:b}}))}function m(a){console.log("model, handleMessagePublished"),l(a.payload.username,a.payload.message)}function n(a){q=a.payload.nick}function o(){return moment().format("h:mm a")}var p,q,r,s,t=a("Nori.Events.AppEventCreator"),u=1,v=a("App.Events.EventConstants"),w=a("Nori.Utils.Dispatcher");c.initialize=d,c.getUsersCollection=e,c.getMessagesCollection=f,c.setUsers=i,c.addUser=j,c.removeUser=k,c.addMessage=l,c.getMyNick=g,c.setMyNick=h,c.prettyNow=o}),define("APP.View.AppSubView",function(a,b,c){function d(a){this.isInitialized()||this.initializeSubView(a)}function e(){}c.initialize=d,c.viewWillUpdate=e}),define("APP.View.AppView",function(a,b,c){function d(){p=this,p.initializeApplicationView(["applicationscaffold","applicationcomponentsscaffold"]),p.setRouteViewMountPoint("#contents"),o(),APP.mapRouteView("/","default","APP.View.AppSubView"),q.applicationViewInitialized()}function e(){p.setEvents({"change #nick-input":f,"change #message-input":j,"focus #message-input":g,"blur #message-input":h,"keydown #message-input":i}),p.delegateEvents(),p.createComponent("user-list","APP.View.UserList","#users"),p.createComponent("message-list","APP.View.MessageList","#message"),p.renderComponent("user-list"),p.renderComponent("message-list")}function f(a){t.updateNick(a.target.value)}function g(){t.startTyping()}function h(){t.endTyping()}function i(){console.log("keying")}function j(){t.publishMessage(k(),m()),n()}function k(){return document.getElementById("nick-input").value}function l(a){document.getElementById("nick-input").value=a}function m(){return document.getElementById("message-input").value}function n(){return document.getElementById("message-input").value=""}function o(){r.subscribe(s.NOTIFY_USER,function(a){p.notify(a.payload.message,a.payload.title,a.payload.type)}),r.subscribe(s.ALERT_USER,function(a){p.alert(a.payload.message,a.payload.title)})}var p,q=a("Nori.Events.AppEventCreator"),r=a("Nori.Utils.Dispatcher"),s=a("Nori.Events.AppEventConstants"),q=a("Nori.Events.AppEventCreator"),t=a("App.Events.EventCreator");c.initialize=d,c.setMyNick=l,c.render=e}),define("APP.View.MessageList",function(a,b,c){function d(a){this.isInitialized()||(g=this,this.initializeSubView(a),APP.registerViewForModelChanges("MessagesCollection",this.getID()))}function e(){var a=Object.create(null);a.messages=[],APP.model().getMessagesCollection().forEach(function(b){var c="";"System"===b.get("username")?c="message__list-display-system":b.get("username")===APP.model().getMyNick()&&(c="message__list-display-me"),a.messages.push({time:b.get("time"),username:b.get("username"),content:b.get("content"),display:c})}),g.setState(a)}function f(){var a=g.getDOMElement().parentNode;a.scrollTop=a.scrollHeight}var g;c.initialize=d,c.viewWillUpdate=e,c.viewDidMount=f}),define("APP.View.UserList",function(a,b,c){function d(a){this.isInitialized()||(f=this,this.initializeSubView(a),APP.registerViewForModelChanges("UsersCollection",this.getID()))}function e(){var a=Object.create(null);a.users=[],APP.model().getUsersCollection().forEach(function(b){a.users.push({username:b.get("username"),display:APP.model().getMyNick()===b.get("username")?"users__list-me":"",status:"",typing:b.get("typing")?"users__list-typing":""})}),f.setState(a)}var f;c.initialize=d,c.viewWillUpdate=e}),function(){var a=require("Nudoru.Browser.BrowserInfo");a.notSupported||a.isIE9?document.querySelector("body").innerHTML="<h3>For the best experience, please use Internet Explorer 10+, Firefox, Chrome or Safari to view this application.</h3>":window.onload=function(){window.APP=Nori.createApplication(require("APP.Application")),APP.initialize()}}();